<!DOCTYPE html>
<html>
<head>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<meta charset="UTF-8" />
<title>ETP for Champs</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body {
  margin: 0;
  font-family: Arial;
  background: #0f0f0f;
  color: white;
  padding: 20px;
}

h1 { margin-top: 0; }

.card {
  background: #1a1a1a;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 10px;
}

button {
  padding: 10px;
  border-radius: 8px;
  border: none;
  font-weight: bold;
  margin-top: 5px;
  width: 100%;
}

.primary { background: #ff0033; color: white; }
.gray { background: #333; color: white; }

.habit {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  background: #1a1a1a;
  border-radius: 10px;
  margin-bottom: 8px;
}

.progress-bar {
  height: 8px;
  background: #333;
  border-radius: 5px;
  overflow: hidden;
  margin-top: 5px;
}

.progress-fill {
  height: 100%;
  background: #ff0033;
  width: 0%;
}
</style>
</head>
<body>

<h1>üî• ETP for Champs</h1>

<div class="card">
  <div id="greeting"></div>
  <div id="streak"></div>
  <div class="progress-bar">
    <div id="progressFill" class="progress-fill"></div>
  </div>
</div>

<div id="habitList"></div>

<button class="primary" onclick="addHabit()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É</button>
<button class="gray" onclick="finishDay()">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–µ–Ω—å</button>

<script>

const SUPABASE_URL = "https://edykbfwlafexxvlqwpcm.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkeWtiZndsYWZleHh2bHF3cGNtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyODA0MDIsImV4cCI6MjA4Njg1NjQwMn0.MN05XvJQrcCQCIcJxOqAZDHWu3qLoCLGKcyjE4ZMGas";

const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY
);

const tg = window.Telegram.WebApp;
tg.expand();

const user = tg.initDataUnsafe.user;

async function initUser() {
  if (!user) return;

  const { data, error } = await supabase
    .from("usersforminiapp")
    .select("*")
    .eq("telegram_id", user.id)
    .single();

  if (!data) {
    const { error: insertError } = await supabase
      .from("usersforminiapp")
      .insert([
        {
          telegram_id: user.id,
          username: user.username || "",
          first_name: user.first_name || "",
          photo_url: user.photo_url || "",
          current_streak: 0,
          max_streak: 0,
          created_at: new Date().toISOString()
        }
      ]);

    if (insertError) console.error(insertError);
  }
}

initUser();

document.getElementById("greeting").innerHTML =
  "–ü—Ä–∏–≤–µ—Ç, " + (user?.first_name || "–ß–µ–º–ø–∏–æ–Ω");

let data = JSON.parse(localStorage.getItem("etpData")) || {
  habits: [],
  completions: {},
  closedDays: [],
  currentStreak: 0,
  maxStreak: 0
};

const today = new Date().toISOString().split("T")[0];

if (data.habits.length === 0) {
  data.habits = [
    { id: 1, title: "‚ö° –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞—Ä—è–¥–∞" },
    { id: 2, title: "üìö –ò–∑—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ" },
    { id: 3, title: "üèã –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞" },
    { id: 4, title: "üíº –†–∞–±–æ—Ç–∞" },
    { id: 5, title: "üßò –†–∞—Å—Ç—è–∂–∫–∞" }
  ];
  save();
}

function save() {
  localStorage.setItem("etpData", JSON.stringify(data));
}

function render() {
  const list = document.getElementById("habitList");
  list.innerHTML = "";

  const todayCompletions = data.completions[today] || [];

  data.habits.forEach(habit => {
    const checked = todayCompletions.includes(habit.id);
    const div = document.createElement("div");
    div.className = "habit";
    div.innerHTML = `
      <span>${habit.title}</span>
      <input type="checkbox" ${checked ? "checked" : ""}
        ${data.closedDays.includes(today) ? "disabled" : ""}
        onchange="toggleHabit(${habit.id})"/>
    `;
    list.appendChild(div);
  });

  updateStats();
}

function toggleHabit(id) {
  if (data.closedDays.includes(today)) return;

  if (!data.completions[today])
    data.completions[today] = [];

  const index = data.completions[today].indexOf(id);

  if (index > -1)
    data.completions[today].splice(index, 1);
  else
    data.completions[today].push(id);

  save();
  render();
}

function addHabit() {
  const title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏:");
  if (!title) return;

  const id = Date.now();
  data.habits.push({ id, title: "üî• " + title });
  save();
  render();
}

function finishDay() {
  const todayCompletions = data.completions[today] || [];

  if (todayCompletions.length === 0) {
    if (!confirm("–¢—ã —Ç–æ—á–Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–¥–µ–ª–∞–ª —Å–µ–≥–æ–¥–Ω—è?"))
      return;
  }

  data.closedDays.push(today);

  if (todayCompletions.length > 0) {
    data.currentStreak++;
    if (data.currentStreak > data.maxStreak)
      data.maxStreak = data.currentStreak;
  } else {
    data.currentStreak = 0;
  }

  save();
  render();
}

function updateStats() {
  const total = data.habits.length;
  const done = (data.completions[today] || []).length;
  const percent = total === 0 ? 0 : (done / total) * 100;

  document.getElementById("progressFill").style.width =
    percent + "%";

  document.getElementById("streak").innerHTML =
    "üî• –°—Ç—Ä–∏–∫: " + data.currentStreak +
    " | üèÜ –ú–∞–∫—Å: " + data.maxStreak;
}

render();
</script>

</body>
</html>