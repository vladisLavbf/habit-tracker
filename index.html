<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ETP for Champs</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
    background:#0f0f0f;
    color:white;
    font-family: Arial;
    padding:20px;
}

button{
    width:100%;
    padding:12px;
    margin-top:8px;
    border:none;
    border-radius:8px;
    font-weight:bold;
    background:#ff0033;
    color:white;
}

.habit{
    display:flex;
    justify-content:space-between;
    padding:12px;
    background:#1a1a1a;
    border-radius:10px;
    margin-bottom:8px;
}

.card{
    background:#1a1a1a;
    padding:15px;
    border-radius:12px;
    margin-bottom:15px;
}

.progress{
    height:8px;
    background:#333;
    border-radius:5px;
    overflow:hidden;
}

.progress-fill{
    height:100%;
    width:0%;
    background:#ff0033;
}
</style>

</head>

<body>

<h2>ðŸ”¥ ETP for Champs</h2>

<div class="card">
<div id="greeting"></div>
<div id="streak"></div>

<div class="progress">
<div id="progressFill" class="progress-fill"></div>
</div>
</div>

<div id="habitList"></div>

<button onclick="addHabit()">âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐºÑƒ</button>
<button onclick="finishDay()">âœ… Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ Ð´ÐµÐ½ÑŒ</button>

<script>

const tg = window.Telegram.WebApp;
tg.expand();

let user = tg.initDataUnsafe?.user;

const SUPABASE_URL = "https://edykbfwlafexxvlqwpcm.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkeWtiZndsYWZleHh2bHF3cGNtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyODA0MDIsImV4cCI6MjA4Njg1NjQwMn0.MN05XvJQrcCQCIcJxOqAZDHWu3qLoCLGKcyjE4ZMGas";

const supabase = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_KEY
);

let today = new Date().toISOString().split("T")[0];

let habits = [];
let completions = {};

async function initUser(){

    if(!user) return;

    document.getElementById("greeting").innerHTML =
        "ÐŸÑ€Ð¸Ð²ÐµÑ‚, " + (user.first_name || "Ð§ÐµÐ¼Ð¿Ð¸Ð¾Ð½");

    let {data} = await supabase
        .from("usersforapp")
        .select("*")
        .eq("telegram_id", user.id)
        .single();

    if(!data){

        await supabase.from("usersforapp").insert([
            {
                telegram_id:user.id,
                username:user.username || "",
                first_name:user.first_name || "",
                current_streak:0,
                max_streak:0,
                created_at:new Date().toISOString()
            }
        ]);
    }

    loadHabits();
}

function loadHabits(){

    habits = [
        {id:1,title:"âš¡ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð·Ð°Ñ€ÑÐ´Ð°"},
        {id:2,title:"ðŸ“š Ð˜Ð·ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾"},
        {id:3,title:"ðŸ‹ Ð¢Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ°"},
        {id:4,title:"ðŸ’¼ Ð Ð°Ð±Ð¾Ñ‚Ð°"},
        {id:5,title:"ðŸ§˜ Ð Ð°ÑÑ‚ÑÐ¶ÐºÐ°"}
    ];

    render();
}

function render(){

    const list = document.getElementById("habitList");
    list.innerHTML = "";

    habits.forEach(habit => {

        const checked =
            completions[today]?.includes(habit.id) || false;

        const div = document.createElement("div");
        div.className = "habit";

        div.innerHTML = `
        <span>${habit.title}</span>
        <input type="checkbox"
        ${checked ? "checked" : ""}
        onchange="toggleHabit(${habit.id})"/>
        `;

        list.appendChild(div);
    });

    updateStats();
}

function toggleHabit(id){

    if(!completions[today])
        completions[today] = [];

    if(completions[today].includes(id)){
        completions[today] =
            completions[today].filter(x=>x!==id);
    }
    else{
        completions[today].push(id);
    }

    updateStats();
}

function addHabit(){

    let title = prompt("ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐºÐ¸");
    if(!title) return;

    habits.push({
        id:Date.now(),
        title:"ðŸ”¥ "+title
    });

    render();
}

function finishDay(){

    let doneCount = completions[today]?.length || 0;

    if(doneCount===0){
        if(!confirm("Ð¢Ñ‹ Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ ÑÐ´ÐµÐ»Ð°Ð» ÑÐµÐ³Ð¾Ð´Ð½Ñ?"))
            return;
    }

    alert("Ð”ÐµÐ½ÑŒ Ð·Ð°Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½!");
}

function updateStats(){

    let streak = 0;

    if(completions[today]?.length > 0){
        streak = 1;
    }

    document.getElementById("streak").innerHTML =
        "ðŸ”¥ Ð¡Ñ‚Ñ€Ð¸Ðº: "+streak;

    document.getElementById("progressFill").style.width =
        ((completions[today]?.length || 0)/habits.length*100)+"%";
}

initUser();

</script>

</body>
</html>