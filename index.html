<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ETP Mini App</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
    background:#0f0f0f;
    color:white;
    font-family: Arial;
    padding:20px;
}

.habit{
    display:flex;
    justify-content:space-between;
    padding:12px;
    background:#1a1a1a;
    border-radius:10px;
    margin-bottom:8px;
}

button{
    width:100%;
    padding:12px;
    margin-top:8px;
    border:none;
    border-radius:8px;
    font-weight:bold;
    background:#ff0033;
    color:white;
}

.card{
    background:#1a1a1a;
    padding:15px;
    border-radius:12px;
    margin-bottom:15px;
}

.progress{
    height:8px;
    background:#333;
    border-radius:5px;
    overflow:hidden;
}

.progress-fill{
    height:100%;
    width:0%;
    background:#ff0033;
}
</style>

</head>

<body>

<h2>üî• ETP for Champs</h2>

<div class="card">
<div id="greeting"></div>
<div id="streak"></div>

<div class="progress">
<div id="progressFill" class="progress-fill"></div>
</div>
</div>

<div id="habitList"></div>

<button onclick="addHabit()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É</button>
<button onclick="finishDay()">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–µ–Ω—å</button>

<script>

const tg = window.Telegram.WebApp;
tg.expand();

let user = tg.initDataUnsafe?.user;

const SUPABASE_URL = "https://edykbfwlafexxvlqwpcm.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkeWtiZndsYWZleHh2bHF3cGNtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyODA0MDIsImV4cCI6MjA4Njg1NjQwMn0.MN05XvJQrcCQCIcJxOqAZDHWu3qLoCLGKcyjE4ZMGas";

const supabase = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_KEY
);

let today = new Date().toISOString().split("T")[0];

let data = {
    habits: [],
    completions: {},
    current_streak: 0,
    max_streak: 0
};

async function initUser(){

    if(!user) return;

    document.getElementById("greeting").innerHTML =
        "–ü—Ä–∏–≤–µ—Ç, " + (user.first_name || "–ß–µ–º–ø–∏–æ–Ω");

    let {data: dbUser} = await supabase
        .from("usersforminiapp")
        .select("*")
        .eq("telegram_id", user.id)
        .single();

    if(!dbUser){

        await supabase.from("usersforminiapp").insert([
            {
                telegram_id:user.id,
                username:user.username || "",
                first_name:user.first_name || "",
                photo_url:user.photo_url || "",
                current_streak:0,
                max_streak:0,
                created_at:new Date().toISOString()
            }
        ]);
    }

    loadHabits();
}

async function loadHabits(){

    // MVP: –ø—Ä–∏–≤—ã—á–∫–∏ –ø–æ–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã–µ
    data.habits = [
        {id:1,title:"‚ö° –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞—Ä—è–¥–∞"},
        {id:2,title:"üìö –ò–∑—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ"},
        {id:3,title:"üèã –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞"},
        {id:4,title:"üíº –†–∞–±–æ—Ç–∞"},
        {id:5,title:"üßò –†–∞—Å—Ç—è–∂–∫–∞"}
    ];

    render();
}

function render(){

    const list = document.getElementById("habitList");
    list.innerHTML = "";

    data.habits.forEach(habit => {

        const div = document.createElement("div");
        div.className = "habit";

        div.innerHTML = `
        <span>${habit.title}</span>
        <input type="checkbox" onchange="toggleHabit(${habit.id})"/>
        `;

        list.appendChild(div);
    });

    updateStats();
}

function toggleHabit(id){

    console.log("toggle habit", id);
}

function addHabit(){

    const title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏");
    if(!title) return;

    data.habits.push({
        id:Date.now(),
        title:"üî• "+title
    });

    render();
}

function finishDay(){
    alert("–§—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–Ω—è –ø–æ–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ");
}

function updateStats(){

    document.getElementById("streak").innerHTML =
        "üî• –°—Ç—Ä–∏–∫: 0 | üèÜ –ú–∞–∫—Å: 0";

    document.getElementById("progressFill").style.width = "0%";
}

initUser();

</script>

</body>
</html>